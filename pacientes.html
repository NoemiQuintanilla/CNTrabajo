<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="estilo.css">
    <title>Pacientes</title>
</head>
<body id="pacientes">
    <div class="row">
        <div class="col-md-12">
            <br>
            &nbsp; &nbsp; &nbsp; &nbsp;
            <a href="index.html"><img src="imagenes/utc.png" alt="" class="logo"></a>
            <br>
        </div>
        <div class="col-md-12">
            <br>
            &nbsp; &nbsp; &nbsp; &nbsp;
            <a href="index.html" class="salir">Salir</a>
            <br>
        </div>
    </div>
    <center><h1 class="txt3 ">Gestion de Pacientes</h1></center>
    <hr>
    
    <form id="form-veterinaria">
        <div class="row">
            <div class="col-md-5">
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                <label for=""><b>Codigo:</b> </label>
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                <input type="text" id="codigo" class="alert alert-warning" >
                <br>
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                <label for=""><b>Edad: </b></label>
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                <input type="text" id="edad" class="alert alert-warning" >
                <br>
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
                <label for=""><b>Fecha de nacimiento: </b></label>
                &nbsp;
                <input type="date" id="fecha_nacimiento" class="alert alert-warning" >
                <br>
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                <label for=""><b>Nombre:</b> </label>
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp; &nbsp;  &nbsp; &nbsp;  &nbsp; 
                <input type="text" id="nombre" class="alert alert-warning"  >
                <br>
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                <label for=""><b>Propietario: </b></label>
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp; &nbsp;  &nbsp; 
                <input type="text" id="propietario" class="alert alert-warning" >
            </div>
            <div class="col-md-4">
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                <label for=""><b>Color: </b></label>
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp; &nbsp;
                <input type="text" id="color" class="alert alert-warning" >
                <br>
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                <label for=""><b>Especie: </b></label>
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
                <input type="text" id="especie" class="alert alert-warning" >
                <br>
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                <label for=""><b>Genéro:</b> </label>
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                <input type="text" id="genero" class="alert alert-warning">
                <br>
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                <label for=""><b>Peso:</b> </label>
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp; &nbsp; 
                <input type="text" id="peso" class="alert alert-warning">
                <br>
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                <label for=""><b>Raza:</b> </label>
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp; &nbsp; 
                <input type="text" id="raza" class="alert alert-warning" >
            </div>
            <div class="col-md-3">
                <br>
                <br>
                <button type="submit" class="btn btn-success" id="btn-submit">Agregar paciente</button>
                <hr>
                <center>
                    <input type="text" name="buscar" id="buscar" class="alert alert-warning" placeholder="Ingrese código">
                    <br>
                    <button type="button" id="btn-buscar" class="btn btn-dark">Buscar</button>
                    <button type="button" id="btn-limpiar" class="btn btn-info">Limpiar</button> 
                    <hr>
                </center>
            </div>             
        </div>
    </form>  
    
    <!-- Contenedor de tarjetas para mostrar los pacientes -->
    <div class="container">
        <center><h2>Lista de Pacientes</h2></center>
        <div class="row" id="lista-pacientes">
            <!-- Las tarjetas de los pacientes se insertarán aquí -->
        </div>
    </div>

    <!-- Modal para editar paciente -->
    <div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditarLabel">Editar Paciente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Formulario dentro del modal para editar los datos del paciente -->
                    <form id="form-editar">
                        <div class="mb-3">
                            <label for="editCodigo" class="form-label">Código</label>
                            <input type="text" class="form-control" id="editCodigo" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="editNombre" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="editNombre">
                        </div>
                        <div class="mb-3">
                            <label for="editPropietario" class="form-label">Propietario</label>
                            <input type="text" class="form-control" id="editPropietario">
                        </div>
                        <div class="mb-3">
                            <label for="editEdad" class="form-label">Edad</label>
                            <input type="text" class="form-control" id="editEdad">
                        </div>
                        <div class="mb-3">
                            <label for="editFechaNacimiento" class="form-label">Fecha de Nacimiento</label>
                            <input type="date" class="form-control" id="editFechaNacimiento">
                        </div>
                        <div class="mb-3">
                            <label for="editColor" class="form-label">Color</label>
                            <input type="text" class="form-control" id="editColor">
                        </div>
                        <div class="mb-3">
                            <label for="editEspecie" class="form-label">Especie</label>
                            <input type="text" class="form-control" id="editEspecie">
                        </div>
                        <div class="mb-3">
                            <label for="editGenero" class="form-label">Género</label>
                            <input type="text" class="form-control" id="editGenero">
                        </div>
                        <div class="mb-3">
                            <label for="editPeso" class="form-label">Peso</label>
                            <input type="text" class="form-control" id="editPeso">
                        </div>
                        <div class="mb-3">
                            <label for="editRaza" class="form-label">Raza</label>
                            <input type="text" class="form-control" id="editRaza">
                        </div>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAv2YFuqtaX6AcoRE7t15WtLGjnjIoi400",
            authDomain: "veterinaria-144cf.firebaseapp.com",
            projectId: "veterinaria-144cf",
            storageBucket: "veterinaria-144cf.appspot.com",
            messagingSenderId: "895686591577",
            appId: "1:895686591577:web:d0c78bb26bd16526e61d48"
        };
      
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const veterinaria = document.getElementById("form-veterinaria");
        veterinaria.addEventListener("submit", async (e) => {
            e.preventDefault();
            const codigo = veterinaria.codigo.value;

            const codigoExistente = await verificarCodigoExistente(codigo);
            if (codigoExistente) {
                alert("El código ya existe. Por favor, ingrese un código único.");
                return;
            }

            await addDoc(collection(db, "pacientes"), {
                codigo: veterinaria.codigo.value,
                color: veterinaria.color.value,
                edad: veterinaria.edad.value,
                especie: veterinaria.especie.value,
                fecha_nacimiento: veterinaria.fecha_nacimiento.value,
                genero: veterinaria.genero.value,
                nombre: veterinaria.nombre.value,
                peso: veterinaria.peso.value,
                propietario: veterinaria.propietario.value,
                raza: veterinaria.raza.value
            });
            veterinaria.reset();
        });

        async function verificarCodigoExistente(codigo) {
            const q = query(collection(db, "pacientes"), where("codigo", "==", codigo));
            const querySnapshot = await getDocs(q);
            return !querySnapshot.empty;
        }

        const listaPacientes = document.getElementById("lista-pacientes");
        onSnapshot(collection(db, "pacientes"), (snapshot) => {
            listaPacientes.innerHTML = "";
            snapshot.forEach((doc) => {
                const paciente = doc.data();
                listaPacientes.innerHTML += `
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">${paciente.nombre}</h5>
                                <p class="card-text"><b>Código:</b> ${paciente.codigo}</p>
                                <p class="card-text"><b>Propietario:</b> ${paciente.propietario}</p>
                                <p class="card-text"><b>Edad:</b> ${paciente.edad}</p>
                                <p class="card-text"><b>Fecha de Nacimiento:</b> ${paciente.fecha_nacimiento}</p>
                                <p class="card-text"><b>Color:</b> ${paciente.color}</p>
                                <p class="card-text"><b>Especie:</b> ${paciente.especie}</p>
                                <p class="card-text"><b>Género:</b> ${paciente.genero}</p>
                                <p class="card-text"><b>Peso:</b> ${paciente.peso}</p>
                                <p class="card-text"><b>Raza:</b> ${paciente.raza}</p>
                                <button class="btn btn-warning btn-edit" data-id="${doc.id}">Editar</button>
                                <button class="btn btn-danger btn-delete" data-id="${doc.id}">Eliminar</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            const editButtons = document.querySelectorAll(".btn-edit");
            editButtons.forEach(button => {
                button.addEventListener("click", (e) => {
                    const id = e.target.dataset.id;
                    openEditModal(id);
                });
            });

            const deleteButtons = document.querySelectorAll(".btn-delete");
            deleteButtons.forEach(button => {
                button.addEventListener("click", async (e) => {
                    const id = e.target.dataset.id;
                    await deleteDoc(doc(db, "pacientes", id));
                });
            });
        });

        function openEditModal(id) {
            const docRef = doc(db, "pacientes", id);
            getDoc(docRef).then((docSnap) => {
                if (docSnap.exists()) {
                    const paciente = docSnap.data();
                    document.getElementById("editCodigo").value = paciente.codigo;
                    document.getElementById("editNombre").value = paciente.nombre;
                    document.getElementById("editPropietario").value = paciente.propietario;
                    document.getElementById("editEdad").value = paciente.edad;
                    document.getElementById("editFechaNacimiento").value = paciente.fecha_nacimiento;
                    document.getElementById("editColor").value = paciente.color;
                    document.getElementById("editEspecie").value = paciente.especie;
                    document.getElementById("editGenero").value = paciente.genero;
                    document.getElementById("editPeso").value = paciente.peso;
                    document.getElementById("editRaza").value = paciente.raza;

                    const formEditar = document.getElementById("form-editar");
                    formEditar.onsubmit = async (e) => {
                        e.preventDefault();
                        await updateDoc(docRef, {
                            nombre: document.getElementById("editNombre").value,
                            propietario: document.getElementById("editPropietario").value,
                            edad: document.getElementById("editEdad").value,
                            fecha_nacimiento: document.getElementById("editFechaNacimiento").value,
                            color: document.getElementById("editColor").value,
                            especie: document.getElementById("editEspecie").value,
                            genero: document.getElementById("editGenero").value,
                            peso: document.getElementById("editPeso").value,
                            raza: document.getElementById("editRaza").value
                        });
                        const modal = bootstrap.Modal.getInstance(document.getElementById("modalEditar"));
                        modal.hide();
                    };

                    const modal = new bootstrap.Modal(document.getElementById("modalEditar"));
                    modal.show();
                }
            });
        }

        const btnBuscar = document.getElementById("btn-buscar");
        btnBuscar.addEventListener("click", () => {
            const codigo = document.getElementById("buscar").value;
            const listaPacientes = document.getElementById("lista-pacientes");
            const cards = listaPacientes.getElementsByClassName("card");
            let pacienteEncontrado = false;

            for (let i = 0; i < cards.length; i++) {
                const card = cards[i];
                const codigoPaciente = card.querySelector(".card-text b:nth-child(2)").nextSibling.nodeValue.trim();

                if (codigoPaciente === codigo) {
                    const nombre = card.querySelector(".card-title").innerText;
                    const propietario = card.querySelector(".card-text b:nth-child(4)").nextSibling.nodeValue.trim();
                    const edad = card.querySelector(".card-text b:nth-child(6)").nextSibling.nodeValue.trim();
                    const fechaNacimiento = card.querySelector(".card-text b:nth-child(8)").nextSibling.nodeValue.trim();
                    const color = card.querySelector(".card-text b:nth-child(10)").nextSibling.nodeValue.trim();
                    const especie = card.querySelector(".card-text b:nth-child(12)").nextSibling.nodeValue.trim();
                    const genero = card.querySelector(".card-text b:nth-child(14)").nextSibling.nodeValue.trim();
                    const peso = card.querySelector(".card-text b:nth-child(16)").nextSibling.nodeValue.trim();
                    const raza = card.querySelector(".card-text b:nth-child(18)").nextSibling.nodeValue.trim();

                    document.getElementById("codigo").value = codigoPaciente;
                    document.getElementById("nombre").value = nombre;
                    document.getElementById("propietario").value = propietario;
                    document.getElementById("edad").value = edad;
                    document.getElementById("fecha_nacimiento").value = fechaNacimiento;
                    document.getElementById("color").value = color;
                    document.getElementById("especie").value = especie;
                    document.getElementById("genero").value = genero;
                    document.getElementById("peso").value = peso;
                    document.getElementById("raza").value = raza;

                    pacienteEncontrado = true;
                    break;
                }
            }

            if (!pacienteEncontrado) {
                alert("No se encontró ningún paciente con ese código.");
            }
        });

        const btnLimpiar = document.getElementById("btn-limpiar");
        btnLimpiar.addEventListener("click", () => {
            veterinaria.reset();
            document.getElementById("buscar").value = "";
        });
    </script>
</body>
</html>
